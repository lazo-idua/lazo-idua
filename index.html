<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TD MELNYK</title>
    <link rel="icon" href="https://lazo-idua.github.io/lazo-idua/Logo.png" type="image/png">
    <link rel="apple-touch-icon" href="https://lazo-idua.github.io/lazo-idua/Logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            flex-direction: column;
            background: #000;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            height: 100vh;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeOut 0.5s ease-out 1.5s forwards;
        }

        .loader img {
            max-width: 50px;
            max-height: 50px;
            opacity: 0;
            animation: growAndFade 1.5s ease-out forwards;
        }

        @keyframes growAndFade {
            0% { transform: scale(0.1); opacity: 0; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: #000;
            z-index: 104;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logo {
            width: 32px;
            height: 32px;
            opacity: 1;
            animation: fadeIn 0.5s ease-out 0.2s forwards;
        }

        .header-title {
            color: white;
            font-size: 16px;
            font-weight: 500;
        }

        .favorites-header-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .favorites-header-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .favorites-header-label {
            display: none;
        }

        .main-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            padding-top: 40px;
            background: #000;
            overflow-y: hidden;
            position: relative;
            height: calc(100vh - 40px - 30px);
        }

        .pdf-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 15px;
            max-width: 100%;
            padding: 10px;
            scroll-behavior: smooth;
            width: 100%;
        }

        .pdf-selection::-webkit-scrollbar {
            display: none;
        }

        .pdf-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-basis: calc(50% - 15px);
            max-width: calc(50% - 15px);
            aspect-ratio: 148 / 210;
        }

        .pdf-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .pdf-thumbnail {
            width: 100%;
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .pdf-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pdf-thumbnail .thumbnail-placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            text-align: center;
            padding: 10px;
        }

        .pdf-thumbnail .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .pdf-thumbnail.loading .thumbnail-placeholder {
            display: none;
        }

        .pdf-thumbnail.loading .loading-spinner {
            display: block;
        }

        .pdf-name {
            color: white;
            font-size: 12px;
            font-weight: 500;
            margin-top: 5px;
        }

        .dots-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0 5px 0;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .dot.active {
            background: white;
        }

        .tooltip {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 105;
            max-width: 90%;
            text-align: center;
            opacity: 0;
            animation: fadeInTooltip 0.5s ease-out forwards, fadeOutTooltip 0.5s ease-out 14.5s forwards;
        }

        @keyframes fadeInTooltip {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            100% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @keyframes fadeOutTooltip {
            0% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }

        .main-content {
            position: absolute;
            top: 40px;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
            padding: 0;
            display: none;
        }
        
        @media (max-width: 480px) {
            .main-content {
                top: 0; /* Зміщено догори */
                bottom: 80px; /* Збільшено відступ знизу для кнопок */
            }
        }

        .main-content.opening {
            animation: fadeInSlideUp 0.7s ease-out forwards;
        }

        @keyframes fadeInSlideUp {
            0% { opacity: 0; transform: translateY(50px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .pdf-container {
            position: relative;
            display: flex;
            flex: 1;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            opacity: 1;
            transition: opacity 0.3s ease;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            z-index: 100;
        }

        .canvas-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .canvas-next {
            position: absolute;
            opacity: 0;
            z-index: -1;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 101;
            padding: 0;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .nav-btn:disabled {
            background: rgba(255, 255, 255, 0.06);
            cursor: not-allowed;
            opacity: 0.4;
            transform: translateY(-50%);
        }
        
        .prev-btn {
            left: 5px;
        }

        .next-btn {
            right: 5px;
        }

        .menu-nav-btn {
            display: none;
        }

        .top-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 101;
        }

        .favorite-container {
            display: none;
        }

        .favorite-label {
            color: rgba(255, 255, 255, 0.4);
            font-size: 11px;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .bottom-right-container {
            position: absolute;
            bottom: 20px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 101;
        }

        .bottom-left-container {
            position: absolute;
            bottom: 20px;
            left: 15px;
            display: flex;
            align-items: center;
            z-index: 101;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            border: 2px solid #000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
        }

        .back-btn:hover {
            background: #fff;
            transform: scale(1.1);
        }

        .favorites-btn, .share-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .favorites-btn:hover, .share-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .favorites-btn.active {
            background: rgba(255, 0, 0, 0.5);
            color: #ff5252;
        }

        .bottom-buttons {
            position: absolute;
            bottom: 20px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 101;
        }

        .heart-btn, .clear-favorites-btn {
            display: none;
        }

        .clear-favorites-btn {
            background: rgba(255, 0, 0, 0.6);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .clear-favorites-btn:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .clear-favorites-btn.visible {
            display: flex;
        }

        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            text-align: center;
            padding: 6px;
            background: #000;
            color: rgba(255, 255, 255, 0.4);
            font-size: 11px;
            border-top: 1px solid #222;
            min-height: 20px;
            z-index: 103;
            height: 30px;
        }

        .footer span {
            letter-spacing: 0.5px;
        }

        .error-message {
            text-align: center;
            color: #ff6b6b;
            padding: 30px;
            font-size: 16px;
        }

        .error-message small {
            display: block;
            margin-top: 10px;
            color: #999;
            font-size: 14px;
        }

        .favorites-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 106;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .favorites-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            height: 40px;
        }

        .favorites-title {
            color: white;
            font-size: 18px;
        }

        .trash-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .trash-btn:hover {
            color: #ff5252;
        }

        .favorites-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #000;
            overflow: hidden;
            min-height: 0;
            padding: 0;
        }

        .favorites-pdf-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: calc(100% - 40px);
            padding: 0;
        }

        .favorites-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 101;
            padding: 0;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .favorites-nav-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .favorites-nav-btn:disabled {
            background: rgba(255, 255, 255, 0.06);
            cursor: not-allowed;
            opacity: 0.4;
            transform: translateY(-50%);
        }

        .favorites-prev-btn {
            left: 10px;
        }

        .favorites-next-btn {
            right: 10px;
        }

        .favorites-bottom-buttons {
            position: absolute;
            bottom: 20px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 101;
        }

        .remove-favorite-btn {
            background: rgba(255, 0, 0, 0.6);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .remove-favorite-btn:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .favorites-back-btn {
            position: absolute;
            bottom: 20px;
            left: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            border: 2px solid #000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            backdrop-filter: blur(5px);
            z-index: 102;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
        }

        .favorites-back-btn:hover {
            background: #fff;
            transform: scale(1.1);
        }

        .favorites-list-view {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start;
            gap: 15px;
            max-width: 100%;
            padding: 10px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .favorites-list-view::-webkit-scrollbar {
            display: none;
        }

        .favorite-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-basis: calc(50% - 15px);
            max-width: calc(50% - 15px);
            aspect-ratio: 148 / 210;
        }

        .favorite-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .favorite-thumbnail {
            width: 100%;
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .favorite-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .favorite-info {
            color: white;
            font-size: 12px;
            font-weight: 500;
        }

        .remove-favorite-x {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.6);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-favorite-x::before {
            content: '×';
        }

        @media (min-width: 768px) {
            .pdf-item, .favorite-item {
                flex-basis: calc(33.333% - 15px);
                max-width: calc(33.333% - 15px);
            }
        }

        @media (min-width: 1200px) {
            .pdf-item, .favorite-item {
                flex-basis: calc(20% - 15px);
                max-width: calc(20% - 15px);
            }
        }

        @media (max-width: 480px) {
            .pdf-thumbnail img {
                object-fit: contain; /* Змінено для запобігання розтягуванню */
            }

            .pdf-item, .favorite-item {
                flex-basis: calc(50% - 10px);
                max-width: calc(50% - 10px);
                gap: 10px;
            }
            .pdf-selection, .favorites-list-view {
                gap: 10px;
            }
        }

        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        .high-quality {
            image-rendering: high-quality;
        }
    </style>
</head>
<body>

    <div class="loader">
        <img src="https://lazo-idua.github.io/lazo-idua/Logo.png" alt="Loading">
    </div>

    <header class="header">
        <div class="header-left">
            <img src="https://lazo-idua.github.io/lazo-idua/Logo.png" alt="Logo" class="header-logo">
            <h1 class="header-title">TD MELNYK</h1>
        </div>
        <button id="favorites-header-btn" class="favorites-header-btn" style="display: none;"><span class="icon">&#10084;</span></button>
    </header>

    <main class="main-menu" id="main-menu">
        <div class="pdf-selection" id="pdf-selection">
            </div>
        <div class="dots-container" id="dots-container" style="display: none;"></div>
        <div class="tooltip" id="tooltip"></div>
    </main>

    <div class="main-content" id="main-content">
        <div class="pdf-container">
            <canvas id="pdf-canvas" class="pdf-canvas"></canvas>
            <button id="prev-btn" class="nav-btn prev-btn">&lt;</button>
            <button id="next-btn" class="nav-btn next-btn">&gt;</button>
        </div>
        <div class="bottom-left-container">
            <button id="back-btn" class="back-btn">&#x2190;</button>
        </div>
        <div class="bottom-right-container">
            <button id="favorites-btn" class="favorites-btn">&#10084;</button>
            <button id="share-btn" class="share-btn">&#x2192;</button>
        </div>
    </div>
    
    <div class="favorites-modal" id="favorites-modal">
        <div class="favorites-header">
            <h2 class="favorites-title">Обрані</h2>
            <button id="close-favorites-btn" class="favorites-back-btn">&#x2190;</button> </div>
        <div class="favorites-content" id="favorites-content">
            <p class="error-message" id="no-favorites-message" style="display: none;">Ви ще не додали жодного каталогу в обрані. <br> <small>Натисніть на &#10084; в режимі перегляду, щоб додати.</small></p>
            <div class="favorites-list-view" id="favorites-list-view">
                </div>
            <div class="favorites-pdf-container" id="favorites-pdf-container" style="display: none;">
                <canvas id="favorites-pdf-canvas" class="favorites-pdf-canvas"></canvas>
                <button id="favorites-prev-btn" class="favorites-nav-btn favorites-prev-btn">&lt;</button>
                <button id="favorites-next-btn" class="favorites-nav-btn favorites-next-btn">&gt;</button>
            </div>
            <div class="favorites-bottom-buttons" id="favorites-bottom-buttons" style="display: none;">
                <button id="remove-favorite-btn" class="remove-favorite-btn">&#10006;</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <span>&copy; 2024 TD MELNYK</span>
    </footer>

    <script src="https://lazo-idua.github.io/lazo-idua/pdf.min.mjs" type="module"></script>
    <script type="module">
        import * as pdfjsLib from 'https://lazo-idua.github.io/lazo-idua/pdf.min.mjs';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://lazo-idua.github.io/lazo-idua/pdf.worker.min.mjs';

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        let currentPageNum = 1;

        const mainContent = document.getElementById('main-content');
        const pdfSelection = document.getElementById('pdf-selection');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const backBtn = document.getElementById('back-btn');
        const favoritesBtn = document.getElementById('favorites-btn');
        const shareBtn = document.getElementById('share-btn');
        const loader = document.getElementById('loader');
        const mainMenu = document.getElementById('main-menu');
        const favoritesModal = document.getElementById('favorites-modal');
        const closeFavoritesBtn = document.getElementById('close-favorites-btn');
        const favoritesHeaderBtn = document.getElementById('favorites-header-btn');
        const favoritesContent = document.getElementById('favorites-content');
        const favoritesListView = document.getElementById('favorites-list-view');
        const noFavoritesMessage = document.getElementById('no-favorites-message');
        const dotsContainer = document.getElementById('dots-container');
        const favoritesPdfContainer = document.getElementById('favorites-pdf-container');
        const favoritesPdfCanvas = document.getElementById('favorites-pdf-canvas');
        const favoritesPrevBtn = document.getElementById('favorites-prev-btn');
        const favoritesNextBtn = document.getElementById('favorites-next-btn');
        const favoritesBottomButtons = document.getElementById('favorites-bottom-buttons');
        const removeFavoriteBtn = document.getElementById('remove-favorite-btn');
        const footer = document.querySelector('.footer');

        let isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        let touchStartX = 0;
        let touchStartTime = 0;
        let currentPdfUrl = '';
        let currentPdfTitle = '';
        const catalogsPerPage = 4;
        let currentCatalogPage = 0;
        let pdfs = [];

        function setPageNavButtonsState(page) {
            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= pdfDoc.numPages;
        }

        function setFavoritesNavButtonsState(page, numPages) {
            favoritesPrevBtn.disabled = page <= 1;
            favoritesNextBtn.disabled = page >= numPages;
        }

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                const canvas = pdfCanvas;
                const canvasWrapper = canvas.parentNode;
                const desiredWidth = canvasWrapper.clientWidth;
                const desiredHeight = canvasWrapper.clientHeight;
                const viewportScale = Math.min(desiredWidth / viewport.width, desiredHeight / viewport.height);
                const newViewport = page.getViewport({ scale: viewportScale });
                
                canvas.height = newViewport.height;
                canvas.width = newViewport.width;

                const renderContext = {
                    canvasContext: canvas.getContext('2d'),
                    viewport: newViewport
                };
                
                const renderTask = page.render(renderContext);

                renderTask.promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            document.getElementById('page-count').textContent = `${num}/${pdfDoc.numPages}`;
            setPageNavButtonsState(num);
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function showPdf(pdfUrl, pdfTitle) {
            currentPdfUrl = pdfUrl;
            currentPdfTitle = pdfTitle;
            pdfjsLib.getDocument(pdfUrl).promise.then(function(doc) {
                pdfDoc = doc;
                pageNum = 1;
                renderPage(pageNum);
                mainMenu.style.display = 'none';
                mainContent.style.display = 'flex';
                mainContent.classList.add('opening');
                footer.style.display = 'none';
                document.getElementById('back-btn').style.display = 'flex';
                updateFavoriteButtonState(pdfUrl);
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                mainMenu.style.display = 'flex';
                mainContent.style.display = 'none';
                footer.style.display = 'block';
                alert('Не вдалося завантажити PDF-файл. Перевірте підключення до мережі.');
            });
        }

        function nextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
            updatePageIndicator();
        }

        function prevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
            updatePageIndicator();
        }

        prevBtn.addEventListener('click', prevPage);
        nextBtn.addEventListener('click', nextPage);

        function updatePageIndicator() {
            // Placeholder for page indicator, not used in this version of UI
        }

        // Handle native back button for mobile
        window.addEventListener('popstate', function(e) {
            if (mainContent.style.display === 'flex' || favoritesModal.style.display === 'flex') {
                closePdfViewer();
                closeFavoritesModal();
            }
        });

        // Add history state for back button functionality
        backBtn.addEventListener('click', function() {
            closePdfViewer();
        });

        function closePdfViewer() {
            mainContent.style.display = 'none';
            mainMenu.style.display = 'flex';
            footer.style.display = 'flex';
            window.history.pushState(null, '', window.location.pathname);
        }

        closeFavoritesBtn.addEventListener('click', function() {
            closeFavoritesModal();
        });

        function closeFavoritesModal() {
            favoritesModal.style.display = 'none';
            mainMenu.style.display = 'flex';
            footer.style.display = 'flex';
            window.history.pushState(null, '', window.location.pathname);
        }

        favoritesHeaderBtn.addEventListener('click', showFavorites);

        function showFavorites() {
            mainMenu.style.display = 'none';
            favoritesModal.style.display = 'flex';
            footer.style.display = 'none';
            renderFavorites();
            window.history.pushState({modal: 'favorites'}, '', '#favorites');
        }

        function renderFavorites() {
            const favorites = JSON.parse(localStorage.getItem('favorites')) || {};
            const favoriteKeys = Object.keys(favorites);
            favoritesListView.innerHTML = '';
            
            if (favoriteKeys.length === 0) {
                noFavoritesMessage.style.display = 'block';
                favoritesListView.style.display = 'none';
            } else {
                noFavoritesMessage.style.display = 'none';
                favoritesListView.style.display = 'flex';
                favoriteKeys.forEach(key => {
                    const favorite = favorites[key];
                    const item = document.createElement('div');
                    item.className = 'favorite-item';
                    item.innerHTML = `
                        <div class="favorite-thumbnail">
                            <img src="${favorite.thumbnail}" alt="Thumbnail">
                            <button class="remove-favorite-x" data-url="${key}">&#10006;</button>
                        </div>
                        <div class="favorite-info">${favorite.title}</div>
                    `;
                    item.addEventListener('click', (e) => {
                        if (e.target.classList.contains('remove-favorite-x')) {
                            removeFavorite(e.target.dataset.url);
                        } else {
                            showPdf(favorite.url, favorite.title);
                            closeFavoritesModal();
                        }
                    });
                    favoritesListView.appendChild(item);
                });
            }
        }

        function removeFavorite(url) {
            let favorites = JSON.parse(localStorage.getItem('favorites')) || {};
            delete favorites[url];
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderFavorites();
            updateFavoriteButtonState(url);
        }

        function toggleFavorite() {
            let favorites = JSON.parse(localStorage.getItem('favorites')) || {};
            if (favorites[currentPdfUrl]) {
                delete favorites[currentPdfUrl];
            } else {
                favorites[currentPdfUrl] = {
                    url: currentPdfUrl,
                    title: currentPdfTitle,
                    thumbnail: pdfCanvas.toDataURL('image/jpeg', 0.8)
                };
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoriteButtonState(currentPdfUrl);
        }

        favoritesBtn.addEventListener('click', toggleFavorite);

        function updateFavoriteButtonState(url) {
            const favorites = JSON.parse(localStorage.getItem('favorites')) || {};
            if (favorites[url]) {
                favoritesBtn.classList.add('active');
            } else {
                favoritesBtn.classList.remove('active');
            }
        }

        shareBtn.addEventListener('click', function() {
            if (navigator.share) {
                navigator.share({
                    title: currentPdfTitle,
                    url: currentPdfUrl
                }).catch(console.error);
            } else {
                alert('Функція "Поділитися" не підтримується вашим пристроєм.');
            }
        });

        fetch('https://lazo-idua.github.io/lazo-idua/catalogs.json')
            .then(response => response.json())
            .then(data => {
                pdfs = data.catalogs;
                renderPdfSelection(currentCatalogPage);
                renderDots();
            })
            .catch(error => {
                console.error('Error fetching catalog data:', error);
                document.getElementById('main-menu').innerHTML = '<p class="error-message">Не вдалося завантажити каталоги. <small>Будь ласка, перевірте підключення до інтернету.</small></p>';
            });

        function renderPdfSelection(page) {
            pdfSelection.innerHTML = '';
            const start = page * catalogsPerPage;
            const end = start + catalogsPerPage;
            const catalogsToRender = pdfs.slice(start, end);

            catalogsToRender.forEach(pdf => {
                const pdfItem = document.createElement('div');
                pdfItem.className = 'pdf-item';
                pdfItem.innerHTML = `
                    <div class="pdf-thumbnail">
                        <img src="${pdf.thumbnail_url}" alt="${pdf.name} thumbnail">
                    </div>
                    <div class="pdf-name">${pdf.name}</div>
                `;
                pdfItem.addEventListener('click', () => {
                    showPdf(pdf.url, pdf.name);
                    window.history.pushState({view: 'pdf'}, '', '#pdf');
                });
                pdfSelection.appendChild(pdfItem);
            });
        }

        function renderDots() {
            const numPages = Math.ceil(pdfs.length / catalogsPerPage);
            if (numPages > 1) {
                dotsContainer.style.display = 'flex';
                dotsContainer.innerHTML = '';
                for (let i = 0; i < numPages; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    if (i === currentCatalogPage) {
                        dot.classList.add('active');
                    }
                    dot.addEventListener('click', () => {
                        currentCatalogPage = i;
                        renderPdfSelection(currentCatalogPage);
                        updateDots();
                    });
                    dotsContainer.appendChild(dot);
                }
            } else {
                dotsContainer.style.display = 'none';
            }
        }

        function updateDots() {
            const dots = dotsContainer.querySelectorAll('.dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentCatalogPage);
            });
        }

        document.getElementById('favorites-header-btn').addEventListener('click', function() {
            showFavorites();
        });

        // Swipe navigation for main menu
        let mainTouchStartX = 0;
        let mainTouchEndTime = 0;
        let mainTouchStartTime = 0;

        mainMenu.addEventListener('touchstart', function(e) {
            mainTouchStartX = e.changedTouches[0].clientX;
            mainTouchStartTime = Date.now();
        }, { passive: true });

        mainMenu.addEventListener('touchend', function(e) {
            const mainTouchEndX = e.changedTouches[0].clientX;
            mainTouchEndTime = Date.now();
            const deltaX = mainTouchEndX - mainTouchStartX;
            const deltaTime = mainTouchEndTime - mainTouchStartTime;
            
            if (deltaTime < 300 && Math.abs(deltaX) > 50) {
                if (deltaX < 0) { // Swipe left
                    nextCatalogPage();
                } else { // Swipe right
                    prevCatalogPage();
                }
            }
        }, { passive: true });

        function nextCatalogPage() {
            const numPages = Math.ceil(pdfs.length / catalogsPerPage);
            if (currentCatalogPage < numPages - 1) {
                currentCatalogPage++;
                renderPdfSelection(currentCatalogPage);
                updateDots();
            }
        }

        function prevCatalogPage() {
            if (currentCatalogPage > 0) {
                currentCatalogPage--;
                renderPdfSelection(currentCatalogPage);
                updateDots();
            }
        }

        function setAppHeight() {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        }

        window.addEventListener('resize', setAppHeight);
        window.addEventListener('orientationchange', function() {
            setTimeout(setAppHeight, 300);
            if (pdfDoc && !pageRendering) {
                setTimeout(function() {
                    renderPage(pageNum);
                }, 350);
            }
        });
        setAppHeight();
    </script>
</body>
</html>
